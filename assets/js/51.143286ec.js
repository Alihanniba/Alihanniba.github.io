(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{554:function(t,v,_){"use strict";_.r(v);var a=_(6),s=Object(a.a)({},(function(){var t=this,v=t.$createElement,_=t._self._c||v;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("p",[_("img",{attrs:{src:"http://share.alihanniba.com/mac/9nm3k.jpg",alt:""}})]),t._v(" "),_("blockquote",[_("p",[t._v("题图：pixabay")])]),t._v(" "),_("p",[_("strong",[t._v("当前读和快照读。顾名思义，当前读就是读的是当前时刻已提交的数据，快照读就是读的是快照生成时候的数据。")])]),t._v(" "),_("p",[t._v("这里概念理解要抛开读出跟写入的物理概念、读写分离的概念等等。这里的读包含了"),_("code",[t._v("SELECT")]),t._v("、"),_("code",[t._v("UPDATE")]),t._v("、"),_("code",[t._v("INSERT")]),t._v("等语句中的处理逻辑。")]),t._v(" "),_("h3",{attrs:{id:"快照是什么"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#快照是什么"}},[t._v("#")]),t._v(" 快照是什么？")]),t._v(" "),_("p",[t._v("视图的逻辑概念。UNDO LOG + MVCC，后面单独讲。")]),t._v(" "),_("p",[t._v("当前时刻很好理解。执行语句的时刻，库里（磁盘+buffer）是什么样子就是什么样子。")]),t._v(" "),_("p",[t._v("快照的生成时间根据隔离级别的不同而有所不同。先复习下隔离级别：")]),t._v(" "),_("ul",[_("li",[t._v("读未提交。一个事务还没提交时，它做的变更就能被别的事务看到。")]),t._v(" "),_("li",[t._v("读提交。一个事务提交之后，它做的变更会被其他事务看到")]),t._v(" "),_("li",[t._v("可重复读。一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。未提交的数据对其他事务不可见")]),t._v(" "),_("li",[t._v("串行化。对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行")])]),t._v(" "),_("p",[_("strong",[t._v("在读未提交隔离级别下，快照是什么时候生成的？")])]),t._v(" "),_("p",[t._v("没有快照，因为不需要，怎么读都读到最新的。不管是否提交")]),t._v(" "),_("p",[_("strong",[t._v("在读已提交隔离级别下，快照是什么时候生成的？")])]),t._v(" "),_("p",[t._v("SQL语句开始执行的时候。")]),t._v(" "),_("p",[_("strong",[t._v("在可重复读隔离级别下，快照是什么时候生成的？")])]),t._v(" "),_("p",[t._v("事务开始的时候")]),t._v(" "),_("h3",{attrs:{id:"下面来举个例子来理解下"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#下面来举个例子来理解下"}},[t._v("#")]),t._v(" 下面来举个例子来理解下")]),t._v(" "),_("p",[_("strong",[t._v("1.读未提交")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("create table t(a int) engine=InnoDB;\n# TODO：设置隔离级别\ninsert into t(a) values(1);\n# 设置隔离级别-读未提交\nset session transaction isolation level READ UNCOMMITTED;\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br"),_("span",{staticClass:"line-number"},[t._v("2")]),_("br"),_("span",{staticClass:"line-number"},[t._v("3")]),_("br"),_("span",{staticClass:"line-number"},[t._v("4")]),_("br"),_("span",{staticClass:"line-number"},[t._v("5")]),_("br")])]),_("table",[_("thead",[_("tr",[_("th",[t._v("事务A")]),t._v(" "),_("th",[t._v("事务A结果")]),t._v(" "),_("th",[t._v("事务B")]),t._v(" "),_("th",[t._v("事务B结果")]),t._v(" "),_("th",[t._v("解答")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("begin transaction")]),t._v(" "),_("td"),t._v(" "),_("td",[t._v("begin transaction")]),t._v(" "),_("td"),t._v(" "),_("td",[t._v("没有视图的概念")])]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("update t set a = 2")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("session A 能 读到 session B还未提交的数据")])]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("commit transaction")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("commit transaction")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")])])]),t._v(" "),_("p",[_("strong",[t._v("实操记录")])]),t._v(" "),_("p",[_("img",{attrs:{src:"http://share.alihanniba.com/mac/8jeki.png",alt:"image-20210828120816148"}})]),t._v(" "),_("p",[_("strong",[t._v("2.读已提交")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("create table t(a int) engine=InnoDB;\n# TODO：设置隔离级别\ninsert into t(a) values(1);\n# 设置隔离级别-读已提交\nset session transaction isolation level READ COMMITTED;\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br"),_("span",{staticClass:"line-number"},[t._v("2")]),_("br"),_("span",{staticClass:"line-number"},[t._v("3")]),_("br"),_("span",{staticClass:"line-number"},[t._v("4")]),_("br"),_("span",{staticClass:"line-number"},[t._v("5")]),_("br")])]),_("table",[_("thead",[_("tr",[_("th",[t._v("事务A")]),t._v(" "),_("th",[t._v("事务A结果")]),t._v(" "),_("th",[t._v("事务B")]),t._v(" "),_("th",[t._v("事务B结果")]),t._v(" "),_("th",[t._v("解答")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("begin transaction")]),t._v(" "),_("td"),t._v(" "),_("td",[t._v("begin transaction")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("update t set a = 2")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("commit transaction")]),t._v(" "),_("td"),t._v(" "),_("td",[t._v("UNDO LOG data = 2")])]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("commit transaction")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")])])]),t._v(" "),_("p",[_("strong",[t._v("实操记录")])]),t._v(" "),_("p",[_("img",{attrs:{src:"http://share.alihanniba.com/mac/lk1zq.png",alt:"image-20210828120955874"}})]),t._v(" "),_("p",[_("strong",[t._v("3.可重复读")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("create table t(a int) engine=InnoDB;\n# TODO：设置隔离级别\ninsert into t(a) values(1);\n# 默认隔离级别\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br"),_("span",{staticClass:"line-number"},[t._v("2")]),_("br"),_("span",{staticClass:"line-number"},[t._v("3")]),_("br"),_("span",{staticClass:"line-number"},[t._v("4")]),_("br")])]),_("table",[_("thead",[_("tr",[_("th",[t._v("事务A")]),t._v(" "),_("th",[t._v("事务A结果")]),t._v(" "),_("th",[t._v("事务B")]),t._v(" "),_("th",[t._v("事务B结果")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("begin transaction")]),t._v(" "),_("td"),t._v(" "),_("td",[t._v("begin transaction")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")])]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("update t set a = 2")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td"),t._v(" "),_("td"),t._v(" "),_("td",[t._v("commit transaction")]),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("1")]),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("commit transaction")]),t._v(" "),_("td"),t._v(" "),_("td"),t._v(" "),_("td")]),t._v(" "),_("tr",[_("td",[t._v("select a from t")]),t._v(" "),_("td",[t._v("2")]),t._v(" "),_("td"),t._v(" "),_("td")])])]),t._v(" "),_("p",[_("strong",[t._v("实操记录")])]),t._v(" "),_("p",[_("img",{attrs:{src:"http://share.alihanniba.com/mac/a78wt.png",alt:"image-20210828113505353"}})]),t._v(" "),_("h3",{attrs:{id:"怎么知道执行的语句是当前读还是快照读"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#怎么知道执行的语句是当前读还是快照读"}},[t._v("#")]),t._v(" 怎么知道执行的语句是当前读还是快照读？")]),t._v(" "),_("p",[_("strong",[t._v("1.在默认隔离级别下，select 语句默认是快照读")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("select a from t where id = 1\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br")])]),_("p",[_("strong",[t._v("2.select 语句加锁是当前读")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("# 共享锁\nselect a from t where id = 1 lock in share mode;\n\n#排他锁\nselect a from t where id = 1 for update;\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br"),_("span",{staticClass:"line-number"},[t._v("2")]),_("br"),_("span",{staticClass:"line-number"},[t._v("3")]),_("br"),_("span",{staticClass:"line-number"},[t._v("4")]),_("br"),_("span",{staticClass:"line-number"},[t._v("5")]),_("br")])]),_("p",[_("strong",[t._v("3.update 语句是当前读")])]),t._v(" "),_("div",{staticClass:"language-mysql line-numbers-mode"},[_("pre",{pre:!0,attrs:{class:"language-text"}},[_("code",[t._v("update t set a = a + 1;\n")])]),t._v(" "),_("div",{staticClass:"line-numbers-wrapper"},[_("span",{staticClass:"line-number"},[t._v("1")]),_("br")])]),_("h3",{attrs:{id:""}},[_("a",{staticClass:"header-anchor",attrs:{href:"#"}},[t._v("#")])]),t._v(" "),_("img",{staticClass:"wechat-num",attrs:{src:"http://share.alihanniba.com/mac/490lq.png"}})])}),[],!1,null,null,null);v.default=s.exports}}]);