(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{532:function(s,a,n){"use strict";n.r(a);var t=n(6),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[n("img",{attrs:{src:"http://share.alihanniba.com/mac/2017-06-21-entrepreneur-2411763_1920.jpg",alt:"题图"}})]),s._v(" "),n("blockquote",[n("p",[s._v("题图：Pixabay")])]),s._v(" "),n("h3",{attrs:{id:"_1-第一次部署-uwsgi部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-第一次部署-uwsgi部署"}},[s._v("#")]),s._v(" 1. 第一次部署: uwsgi部署")]),s._v(" "),n("p",[s._v("配置文件如下：")]),s._v(" "),n("div",{staticClass:"language-ini line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ini"}},[n("code",[s._v("uwsgi.ini\n\n"),n("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[uwsgi]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 入口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("module")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" run:app")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("master")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" true")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("processes")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 5")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 线程数")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("threads")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 100")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# io")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("gevent")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 100")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 100")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("chdir")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /var/www/Bank-admin")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" :8005")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("chmod-socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 660")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("vacuum")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" true")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("die-on-term")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" true")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后台运行")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("daemonize")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" true")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("log")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /var/log/bank.log")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("p",[s._v("启动：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("uwsgi --ini uwsgi.ini\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("缺点：")]),s._v(" "),n("ul",[n("li",[s._v("无法有效管理线程数")]),s._v(" "),n("li",[s._v("程序奔溃时无法自动重启")])]),s._v(" "),n("p",[s._v("于是换种方式部署")]),s._v(" "),n("h3",{attrs:{id:"_2-第二次部署-gunicorn部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-第二次部署-gunicorn部署"}},[s._v("#")]),s._v(" 2. 第二次部署: gunicorn部署")]),s._v(" "),n("div",{staticClass:"language-s line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("gunicorn -w 4 -b 0.0.0.1:8005 run:app\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("缺点：")]),s._v(" "),n("p",[s._v("程序奔溃时无法自动重启")]),s._v(" "),n("p",[s._v("再换种方式")]),s._v(" "),n("h3",{attrs:{id:"_3-第三次部署-supervisor部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-第三次部署-supervisor部署"}},[s._v("#")]),s._v(" 3. 第三次部署: supervisor部署")]),s._v(" "),n("p",[s._v("配置文件如下：")]),s._v(" "),n("div",{staticClass:"language-conf line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("supervisor.conf\n\n[program:run]\n# 程序入口\ncommand=/root/.pyenv/versions/2.7.13/envs/bank-env-2.7.13/bin/gunicorn -w 4 -b 0.0.0.0:8005 run:app\n# 程序所在目录\ndirectory=/var/www/Bank-admin\n\nstartsecs=5\n\nstopwaitsecs=3\n\nautostart=true\n# 自动重启\nautorestart=true\n\nstdout_logfile=/var/www/bank/log/gunicorn.log\nstderr_logfile=/var/www/bank/log/gunicorn.err\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("相应命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("通过配置文件启动supervisor\n- supervisord -c supervisor.conf        \n察看supervisor的状态                        \n- supervisorctl -c supervisor.conf status  \n重新载入 配置文件                  \n- supervisorctl -c supervisor.conf reload  \n启动指定/所有 supervisor管理的程序进程                  \n- supervisorctl -c supervisor.conf start [all]|[appname]    \n关闭指定/所有 supervisor管理的程序进程 \n- supervisorctl -c supervisor.conf stop [all]|[appname]\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("通过命令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("supervisord -c supervisor.conf  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("启动后，进程跑得很正常，只是莫名其妙的会报400，所有请求都是400。google到一些结果说是需要添加allowed_hosts, 这个在程序入口处就有添加，既然uwsgi与gunicorn启动正常，应该不是这里的原因。继续排查，发现nginx转发那块配置有问题，少写了一个 gunicorn 配置的转发，加上即可。")]),s._v(" "),n("p",[s._v("添加如下，@ 符号后面的 \\ 去掉，此处为显示效果需要")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location / {\n    ...\n    try_files $uri @\\gunicorn_proxy;\n    ...\n}\nlocation @\\gunicorn_proxy {\n       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n       proxy_set_header Host $http_host;\n       proxy_pass http://127.0.0.1:8005;\n}\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("hr"),s._v(" "),n("p",[s._v("截止到目前，暂时跑得正常。")]),s._v(" "),n("h3",{attrs:{id:""}},[n("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])]),s._v(" "),n("img",{staticClass:"wechat-num",attrs:{src:"http://share.alihanniba.com/mac/490lq.png"}})])}),[],!1,null,null,null);a.default=r.exports}}]);